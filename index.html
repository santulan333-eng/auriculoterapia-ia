<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Diagnóstico MTC</title>
</head>
<body>
  <h1>Subir imágenes de orejas</h1>

  <form id="diagnosticoForm">
    <label>Oreja Izquierda:</label>
    <input type="file" id="orejaIzquierda" accept="image/*" required><br><br>

    <label>Oreja Derecha:</label>
    <input type="file" id="orejaDerecha" accept="image/*" required><br><br>

    <button type="submit">Enviar</button>
  </form>

  <div id="resultado"></div>

  <script>
    // Convertir archivo a Base64
    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = (error) => reject(error);
      });
    }

    document.getElementById("diagnosticoForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const resultado = document.getElementById("resultado");
      resultado.innerHTML = "Procesando... ⏳";

      const orejaIzqFile = document.getElementById("orejaIzquierda").files[0];
      const orejaDerFile = document.getElementById("orejaDerecha").files[0];

      if (!orejaIzqFile || !orejaDerFile) {
        alert("Por favor selecciona ambas imágenes.");
        return;
      }

      try {
        const orejaIzqBase64 = await toBase64(orejaIzqFile);
        const orejaDerBase64 = await toBase64(orejaDerFile);

        const response = await fetch("/.netlify/functions/diagnostico", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            orejaIzquierda: orejaIzqBase64,
            orejaDerecha: orejaDerBase64,
          }),
        });

        let data;
        try {
          data = await response.json();
        } catch (err) {
          const text = await response.text();
          console.error("Respuesta no es JSON:", text);
          resultado.innerHTML = "❌ Error en el servidor: " + text;
          return;
        }

        if (data.error) {
          resultado.innerHTML = "⚠️ " + data.error;
        } else {
          resultado.innerHTML = "<h3>✅ Resultado del análisis</h3><pre>" + JSON.stringify(data, null, 2) + "</pre>";
        }
      } catch (error) {
        console.error("Error en frontend:", error);
        resultado.innerHTML = "❌ Error al procesar el análisis.";
      }
    });
  </script>
</body>
</html>
