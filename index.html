import OpenAI from "openai";
import { PDFDocument, StandardFonts, rgb } from "pdf-lib";

// Cliente de OpenAI
const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

export async function handler(event) {
  if (event.httpMethod !== "POST") {
    return { statusCode: 405, body: JSON.stringify({ error: "Método no permitido" }) };
  }

  try {
    const body = JSON.parse(event.body);
    const { orejaIzquierda, orejaDerecha } = body;

    if (!orejaIzquierda || !orejaDerecha) {
      return { statusCode: 400, body: JSON.stringify({ error: "Faltan imágenes de las orejas" }) };
    }

    // 🔹 Prompt detallado para análisis auriculoterapia
    const prompt = `
Analiza las imágenes de ambas orejas según la Medicina Tradicional China.
Debes:
- Describir cada punto auricular visible.
- Analizar textura, color, marcas y cambios de tono.
- Diferenciar entre disfunciones pasadas (marcas, cicatrices, hundimientos) y actuales (cambios recientes, inflamaciones, rojeces).
- Resaltar órganos o sistemas afectados con explicación breve y clara.
- Dar recomendaciones generales de estilo de vida o cuidados.
Formato esperado: JSON con secciones claras.
    `;

    // 🔹 Llamada a OpenAI Vision
    const completion = await client.chat.completions.create({
      model: "gpt-4o-mini", // ✅ gratis con tu cuenta free
      messages: [
        { role: "system", content: "Eres un experto en auriculoterapia y diagnóstico energético." },
        {
          role: "user",
          content: [
            { type: "text", text: prompt },
            { type: "image_url", image_url: { url: orejaIzquierda } },
            { type: "image_url", image_url: { url: orejaDerecha } }
          ]
        }
      ],
      max_tokens: 800
    });

    const analisisTexto = completion.choices[0].message.content;

    // 🔹 Crear PDF
    const pdfDoc = await PDFDocument.create();
    const page = pdfDoc.addPage([600, 800]);
    const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
    const { height } = page.getSize();

    const lines = analisisTexto.split("\n");
    let y = height - 50;

    lines.forEach((line) => {
      if (y < 50) {
        page.addPage();
        y = height - 50;
      }
      page.drawText(line, {
        x: 50,
        y,
        size: 12,
        font,
        color: rgb(0, 0, 0),
      });
      y -= 18;
    });

    const pdfBytes = await pdfDoc.save();
    const pdfBase64 = Buffer.from(pdfBytes).toString("base64");

    return {
      statusCode: 200,
      body: JSON.stringify({
        analisis: analisisTexto,
        pdf: `data:application/pdf;base64,${pdfBase64}`
      })
    };

  } catch (error) {
    console.error("❌ Error en diagnostico.js:", error);
    return {
      statusCode: 500,
      body: JSON.stringify({ error: "Error al procesar el análisis", detalle: error.message })
    };
  }
}
