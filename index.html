<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Auriculoterapia MTC</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .preview { max-width: 200px; margin: 10px; }
  </style>
</head>
<body>
  <h1>Guía de Auriculoterapia</h1>

  <label>Oreja izquierda:</label>
  <input type="file" id="orejaIzquierda" accept="image/*"><br><br>

  <label>Oreja derecha:</label>
  <input type="file" id="orejaDerecha" accept="image/*"><br><br>

  <button id="analizarBtn">Obtener Guía</button>
  <p id="estado"></p>
  <div id="resultado"></div>

  <script>
    const analizarBtn = document.getElementById("analizarBtn");
    const estado = document.getElementById("estado");
    const resultado = document.getElementById("resultado");

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
      });
    }

    analizarBtn.addEventListener("click", async () => {
      try {
        estado.textContent = "⏳ Analizando...";
        resultado.innerHTML = "";

        const izquierdaFile = document.getElementById("orejaIzquierda").files[0];
        const derechaFile = document.getElementById("orejaDerecha").files[0];

        const orejaIzquierda = izquierdaFile ? await toBase64(izquierdaFile) : null;
        const orejaDerecha = derechaFile ? await toBase64(derechaFile) : null;

        // Paso 1: pedir análisis
        const res = await fetch("/.netlify/functions/diagnostico", {
          method: "POST",
          body: JSON.stringify({ orejaIzquierda, orejaDerecha }),
        });

        const data = await res.json();
        if (data.error) throw new Error(data.error);

        estado.textContent = "✅ Guía recibida";

        resultado.innerHTML = `
          <h2>Resultado</h2>
          <h3>Oreja izquierda</h3>
          <p>${data.guia.izquierda || "No analizada"}</p>
          <h3>Oreja derecha</h3>
          <p>${data.guia.derecha || "No analizada"}</p>
          <button id="descargarPDF">Descargar PDF</button>
        `;

        document.getElementById("descargarPDF").addEventListener("click", async () => {
          const pdfRes = await fetch("/.netlify/functions/pdf", {
            method: "POST",
            body: JSON.stringify({
              orejaIzquierda,
              orejaDerecha,
              guia: data.guia,
            }),
          });

          const pdfBlob = await pdfRes.blob();
          const url = URL.createObjectURL(pdfBlob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "guia-auriculoterapia.pdf";
          a.click();
        });
      } catch (err) {
        estado.textContent = "⚠️ Error: " + err.message;
      }
    });
  </script>
</body>
</html>
