<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gu√≠a Reflexol√≥gica de Auriculoterapia</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 20px;
    }
    h1 {
      color: #2c3e50;
      margin-bottom: 20px;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 650px;
      text-align: center;
      margin-bottom: 20px;
    }
    input, button {
      margin: 10px 0;
      padding: 10px;
      width: 100%;
      max-width: 400px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button {
      background: #3498db;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #2980b9;
    }
    #resultado {
      margin-top: 20px;
      padding: 15px;
      background: #ecf0f1;
      border-radius: 8px;
      white-space: pre-wrap;
      text-align: left;
      font-size: 16px;
      color: #2c3e50;
    }
    #descargarPDF {
      margin-top: 20px;
      display: none;
      background: #27ae60;
    }
    #descargarPDF:hover {
      background: #1e8449;
    }
  </style>
</head>
<body>
  <h1>Gu√≠a Reflexol√≥gica de Auriculoterapia</h1>

  <div class="container">
    <h2>Oreja Izquierda</h2>
    <input type="file" id="fotoInputIzquierda" accept="image/*" />
    <button onclick="enviarFoto('Izquierda')">Analizar Oreja Izquierda</button>
  </div>

  <div class="container">
    <h2>Oreja Derecha</h2>
    <input type="file" id="fotoInputDerecha" accept="image/*" />
    <button onclick="enviarFoto('Derecha')">Analizar Oreja Derecha</button>
  </div>

  <div class="container">
    <h2>Resultado</h2>
    <div id="resultado">Aqu√≠ aparecer√°n las gu√≠as reflexol√≥gicas...</div>
    <button id="descargarPDF" onclick="descargarPDF()">üì• Descargar PDF</button>
  </div>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    const MAX_WIDTH = 800;
    let resultados = {};     // { izquierda: "texto...", derecha: "texto..." }
    let imagenes = {};       // { izquierda: base64, derecha: base64 }

    async function enviarFoto(oreja) {
      const fileInput = document.getElementById(`fotoInput${oreja}`);
      const resultadoDiv = document.getElementById("resultado");
      const btnPDF = document.getElementById("descargarPDF");

      if (fileInput.files.length === 0) {
        resultadoDiv.innerText = `‚ö†Ô∏è Por favor selecciona la oreja ${oreja.toLowerCase()} primero.`;
        return;
      }

      const file = fileInput.files[0];

      try {
        const base64Image = await comprimirImagen(file);

        resultadoDiv.innerText = `‚è≥ Procesando la oreja ${oreja.toLowerCase()}...`;

        const response = await fetch("/.netlify/functions/diagnostico", {
          method: "POST",
          body: JSON.stringify({
            imagen: base64Image,
            oreja: oreja.toLowerCase(),
          }),
        });

        const data = await response.json();

        if (data.guia) {
          resultados[oreja] = data.guia;
          imagenes[oreja] = base64Image;

          let textoFinal = "";
          if (resultados["Izquierda"]) {
            textoFinal += `üìå Oreja Izquierda:\n${resultados["Izquierda"]}\n\n`;
          }
          if (resultados["Derecha"]) {
            textoFinal += `üìå Oreja Derecha:\n${resultados["Derecha"]}\n`;
          }

          resultadoDiv.innerText = `‚úÖ Gu√≠as obtenidas:\n\n${textoFinal}`;
          btnPDF.style.display = "inline-block";
        } else {
          resultadoDiv.innerText = `‚ö†Ô∏è Error: ${data.error || "No se pudo obtener gu√≠a"}`;
        }
      } catch (err) {
        console.error(err);
        resultadoDiv.innerText = `‚ö†Ô∏è Error al procesar la oreja ${oreja}`;
      }
    }

    function comprimirImagen(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement("canvas");
            let width = img.width;
            let height = img.height;

            if (width > MAX_WIDTH || height > MAX_WIDTH) {
              if (width > height) {
                height *= MAX_WIDTH / width;
                width = MAX_WIDTH;
              } else {
                width *= MAX_WIDTH / height;
                height = MAX_WIDTH;
              }
            }

            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);

            const compressedBase64 = canvas.toDataURL("image/jpeg", 0.8);
            resolve(compressedBase64);
          };
          img.onerror = reject;
          img.src = event.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function descargarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 20;

      doc.setFont("helvetica", "bold");
      doc.setFontSize(16);
      doc.text("Gu√≠a Reflexol√≥gica de Auriculoterapia", 20, y);
      y += 15;

      ["Izquierda", "Derecha"].forEach((oreja) => {
        if (resultados[oreja]) {
          doc.setFont("helvetica", "bold");
          doc.setFontSize(14);
          doc.text(`Oreja ${oreja}`, 20, y);
          y += 10;

          if (imagenes[oreja]) {
            doc.addImage(imagenes[oreja], "JPEG", 20, y, 50, 70);
            y += 80;
          }

          doc.setFont("helvetica", "normal");
          doc.setFontSize(12);
          const texto = doc.splitTextToSize(resultados[oreja], 170);
          doc.text(texto, 20, y);
          y += texto.length * 7 + 10;
        }
      });

      doc.setFontSize(10);
      doc.text(
        "Nota: Esta gu√≠a es orientativa y no reemplaza la evaluaci√≥n de un m√©dico o profesional de la salud.",
        20,
        280,
        { maxWidth: 170 }
      );

      doc.save("guia-auriculoterapia.pdf");
    }
  </script>
</body>
</html>

